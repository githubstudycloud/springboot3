# 数据治理模块设计 (续)

## platform-data-governance-lineage (续)

**领域模型 (续)**:

```java
/**
 * 数据血缘域模型
 */
public class DataLineage implements AggregateRoot<LineageId> {
    // ... 前面的代码已在前一部分定义 ...
    
    public LineageEdge addEdge(String sourceNodeId, String targetNodeId, EdgeType type, 
                              Map<String, String> properties, String createdBy) {
        // 验证源节点和目标节点存在
        boolean sourceExists = this.nodes.stream()
            .anyMatch(node -> node.getNodeId().equals(sourceNodeId));
            
        boolean targetExists = this.nodes.stream()
            .anyMatch(node -> node.getNodeId().equals(targetNodeId));
            
        if (!sourceExists || !targetExists) {
            throw new IllegalArgumentException("Source or target node does not exist");
        }
        
        LineageEdge edge = new LineageEdge(
            LineageEdgeId.generate(),
            this.id.getValue(),
            sourceNodeId,
            targetNodeId,
            type,
            createdBy
        );
        
        if (properties != null) {
            properties.forEach(edge::addProperty);
        }
        
        this.edges.add(edge);
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = createdBy;
        
        return edge;
    }
    
    public void removeNode(String nodeId, String updatedBy) {
        // 同时删除与该节点相关的所有边
        this.edges.removeIf(edge -> 
            edge.getSourceNodeId().equals(nodeId) || edge.getTargetNodeId().equals(nodeId)
        );
        
        this.nodes.removeIf(node -> node.getNodeId().equals(nodeId));
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = updatedBy;
    }
    
    public void removeEdge(String sourceNodeId, String targetNodeId, String updatedBy) {
        this.edges.removeIf(edge -> 
            edge.getSourceNodeId().equals(sourceNodeId) && edge.getTargetNodeId().equals(targetNodeId)
        );
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = updatedBy;
    }
    
    @Override
    public LineageId getId() {
        return id;
    }
    
    // Getter methods
}

/**
 * 血缘节点
 */
@Entity
@Table(name = "gov_lineage_node")
public class LineageNode {
    @EmbeddedId
    private LineageNodeId id;
    
    @Column(name = "lineage_id", nullable = false)
    private String lineageId;
    
    @Column(name = "node_id", nullable = false)
    private String nodeId;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Column(name = "node_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private NodeType type;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @ElementCollection
    @CollectionTable(name = "gov_lineage_node_property", 
                     joinColumns = @JoinColumn(name = "node_id"))
    @MapKeyColumn(name = "property_key")
    @Column(name = "property_value")
    private Map<String, String> properties = new HashMap<>();
    
    protected LineageNode() {}
    
    public LineageNode(LineageNodeId id, String lineageId, String nodeId, 
                      String name, NodeType type, String createdBy) {
        this.id = id;
        this.lineageId = lineageId;
        this.nodeId = nodeId;
        this.name = name;
        this.type = type;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    public void addProperty(String key, String value) {
        this.properties.put(key, value);
        this.updatedAt = LocalDateTime.now();
    }
    
    public void removeProperty(String key) {
        this.properties.remove(key);
        this.updatedAt = LocalDateTime.now();
    }
    
    // Getter methods
    
    public LineageNodeId getId() {
        return id;
    }
    
    public String getNodeId() {
        return nodeId;
    }
    
    public String getName() {
        return name;
    }
    
    public NodeType getType() {
        return type;
    }
    
    public Map<String, String> getProperties() {
        return Collections.unmodifiableMap(properties);
    }
}

/**
 * 血缘边
 */
@Entity
@Table(name = "gov_lineage_edge")
public class LineageEdge {
    @EmbeddedId
    private LineageEdgeId id;
    
    @Column(name = "lineage_id", nullable = false)
    private String lineageId;
    
    @Column(name = "source_node_id", nullable = false)
    private String sourceNodeId;
    
    @Column(name = "target_node_id", nullable = false)
    private String targetNodeId;
    
    @Column(name = "edge_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private EdgeType type;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @ElementCollection
    @CollectionTable(name = "gov_lineage_edge_property", 
                     joinColumns = @JoinColumn(name = "edge_id"))
    @MapKeyColumn(name = "property_key")
    @Column(name = "property_value")
    private Map<String, String> properties = new HashMap<>();
    
    protected LineageEdge() {}
    
    public LineageEdge(LineageEdgeId id, String lineageId, String sourceNodeId, 
                      String targetNodeId, EdgeType type, String createdBy) {
        this.id = id;
        this.lineageId = lineageId;
        this.sourceNodeId = sourceNodeId;
        this.targetNodeId = targetNodeId;
        this.type = type;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    public void addProperty(String key, String value) {
        this.properties.put(key, value);
        this.updatedAt = LocalDateTime.now();
    }
    
    public void removeProperty(String key) {
        this.properties.remove(key);
        this.updatedAt = LocalDateTime.now();
    }
    
    // Getter methods
    
    public LineageEdgeId getId() {
        return id;
    }
    
    public String getSourceNodeId() {
        return sourceNodeId;
    }
    
    public String getTargetNodeId() {
        return targetNodeId;
    }
    
    public EdgeType getType() {
        return type;
    }
    
    public Map<String, String> getProperties() {
        return Collections.unmodifiableMap(properties);
    }
}
```

**应用服务**：

```java
/**
 * 血缘应用服务
 */
@Service
@Transactional
public class LineageApplicationService implements LineageService {
    private final DataLineageRepository lineageRepository;
    private final DomainEventPublisher eventPublisher;
    
    @Override
    public DataLineageDTO createDataLineage(CreateDataLineageCommand command) {
        // 创建血缘
        DataLineage lineage = new DataLineage(
            LineageId.generate(),
            command.getName(),
            command.getType(),
            command.getCreatedBy()
        );
        
        // 设置描述
        lineage.setDescription(command.getDescription());
        
        // 设置作业信息
        if (command.getJobId() != null) {
            lineage.setJobId(command.getJobId());
        }
        
        if (command.getJobName() != null) {
            lineage.setJobName(command.getJobName());
        }
        
        // 添加节点
        if (command.getNodes() != null) {
            for (LineageNodeDTO node : command.getNodes()) {
                lineage.addNode(
                    node.getNodeId(),
                    node.getName(),
                    node.getType(),
                    node.getProperties(),
                    command.getCreatedBy()
                );
            }
        }
        
        // 添加边
        if (command.getEdges() != null) {
            for (LineageEdgeDTO edge : command.getEdges()) {
                lineage.addEdge(
                    edge.getSourceNodeId(),
                    edge.getTargetNodeId(),
                    edge.getType(),
                    edge.getProperties(),
                    command.getCreatedBy()
                );
            }
        }
        
        // 保存血缘
        lineageRepository.save(lineage);
        
        // 发布领域事件
        eventPublisher.publish(new DataLineageCreatedEvent(
            lineage.getId().getValue(),
            lineage.getName(),
            lineage.getType().name()
        ));
        
        // 返回DTO
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    @Override
    public DataLineageDTO getDataLineage(String lineageId) {
        DataLineage lineage = findLineageById(lineageId);
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    @Override
    public DataLineageDTO addNode(AddLineageNodeCommand command) {
        // 获取血缘
        DataLineage lineage = findLineageById(command.getLineageId());
        
        // 添加节点
        lineage.addNode(
            command.getNodeId(),
            command.getName(),
            command.getType(),
            command.getProperties(),
            command.getCreatedBy()
        );
        
        // 保存血缘
        lineageRepository.save(lineage);
        
        // 发布领域事件
        eventPublisher.publish(new LineageNodeAddedEvent(
            lineage.getId().getValue(),
            command.getNodeId(),
            command.getName()
        ));
        
        // 返回DTO
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    @Override
    public DataLineageDTO addEdge(AddLineageEdgeCommand command) {
        // 获取血缘
        DataLineage lineage = findLineageById(command.getLineageId());
        
        // 添加边
        lineage.addEdge(
            command.getSourceNodeId(),
            command.getTargetNodeId(),
            command.getType(),
            command.getProperties(),
            command.getCreatedBy()
        );
        
        // 保存血缘
        lineageRepository.save(lineage);
        
        // 发布领域事件
        eventPublisher.publish(new LineageEdgeAddedEvent(
            lineage.getId().getValue(),
            command.getSourceNodeId(),
            command.getTargetNodeId()
        ));
        
        // 返回DTO
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    @Override
    public DataLineageDTO getUpstreamLineage(String objectId, String objectType, int depth) {
        // 构建查询条件
        LineageQueryCriteria criteria = LineageQueryCriteria.builder()
            .objectId(objectId)
            .objectType(objectType)
            .direction(LineageDirection.UPSTREAM)
            .depth(depth)
            .build();
        
        // 查询血缘
        DataLineage lineage = lineageRepository.findByQuery(criteria);
        
        // 如果没有找到，创建一个空的血缘
        if (lineage == null) {
            lineage = new DataLineage(
                LineageId.generate(),
                "Upstream lineage for " + objectType + " " + objectId,
                LineageType.COLUMN,
                "system"
            );
        }
        
        // 返回DTO
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    @Override
    public DataLineageDTO getDownstreamLineage(String objectId, String objectType, int depth) {
        // 构建查询条件
        LineageQueryCriteria criteria = LineageQueryCriteria.builder()
            .objectId(objectId)
            .objectType(objectType)
            .direction(LineageDirection.DOWNSTREAM)
            .depth(depth)
            .build();
        
        // 查询血缘
        DataLineage lineage = lineageRepository.findByQuery(criteria);
        
        // 如果没有找到，创建一个空的血缘
        if (lineage == null) {
            lineage = new DataLineage(
                LineageId.generate(),
                "Downstream lineage for " + objectType + " " + objectId,
                LineageType.COLUMN,
                "system"
            );
        }
        
        // 返回DTO
        return DataLineageDTOAssembler.toDTO(lineage);
    }
    
    private DataLineage findLineageById(String lineageId) {
        return lineageRepository.findById(LineageId.of(lineageId))
            .orElseThrow(() -> new LineageNotFoundException("Lineage not found: " + lineageId));
    }
}
```

### platform-data-governance-standard

**职责**：
- 实现数据标准管理功能
- 提供标准定义、版本控制和发布机制
- 支持标准应用和合规检查

**领域模型**：

```java
/**
 * 数据标准域模型
 */
@Entity
@Table(name = "gov_data_standard")
public class DataStandard implements AggregateRoot<DataStandardId> {
    @EmbeddedId
    private DataStandardId id;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "standard_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private StandardType type;
    
    @Column(name = "domain")
    private String domain;
    
    @Column(name = "version", nullable = false)
    private String version;
    
    @Column(name = "status", nullable = false)
    @Enumerated(EnumType.STRING)
    private StandardStatus status;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @OneToMany(mappedBy = "standardId", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<StandardDefinition> definitions = new HashSet<>();
    
    protected DataStandard() {}
    
    public DataStandard(DataStandardId id, String name, StandardType type, 
                       String version, String createdBy) {
        this.id = id;
        this.name = name;
        this.type = type;
        this.version = version;
        this.status = StandardStatus.DRAFT;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    public void addDefinition(String name, String description, String validationRule, 
                             String createdBy) {
        StandardDefinition definition = new StandardDefinition(
            StandardDefinitionId.generate(),
            this.id.getValue(),
            name,
            validationRule,
            createdBy
        );
        
        definition.setDescription(description);
        this.definitions.add(definition);
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = createdBy;
    }
    
    public void removeDefinition(StandardDefinitionId definitionId, String updatedBy) {
        this.definitions.removeIf(d -> d.getId().equals(definitionId));
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = updatedBy;
    }
    
    public void publish(String updatedBy) {
        if (this.status == StandardStatus.DRAFT) {
            this.status = StandardStatus.PUBLISHED;
            this.updatedAt = LocalDateTime.now();
            this.updatedBy = updatedBy;
        } else {
            throw new IllegalStateException("Only draft standards can be published");
        }
    }
    
    public void deprecate(String updatedBy) {
        if (this.status == StandardStatus.PUBLISHED) {
            this.status = StandardStatus.DEPRECATED;
            this.updatedAt = LocalDateTime.now();
            this.updatedBy = updatedBy;
        } else {
            throw new IllegalStateException("Only published standards can be deprecated");
        }
    }
    
    public void archive(String updatedBy) {
        if (this.status == StandardStatus.DEPRECATED) {
            this.status = StandardStatus.ARCHIVED;
            this.updatedAt = LocalDateTime.now();
            this.updatedBy = updatedBy;
        } else {
            throw new IllegalStateException("Only deprecated standards can be archived");
        }
    }
    
    @Override
    public DataStandardId getId() {
        return id;
    }
    
    // Getter methods
}

/**
 * 标准定义
 */
@Entity
@Table(name = "gov_standard_definition")
public class StandardDefinition {
    @EmbeddedId
    private StandardDefinitionId id;
    
    @Column(name = "standard_id", nullable = false)
    private String standardId;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "validation_rule", nullable = false, columnDefinition = "TEXT")
    private String validationRule;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    protected StandardDefinition() {}
    
    public StandardDefinition(StandardDefinitionId id, String standardId, String name, 
                             String validationRule, String createdBy) {
        this.id = id;
        this.standardId = standardId;
        this.name = name;
        this.validationRule = validationRule;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    // Getter and setter methods
    
    public StandardDefinitionId getId() {
        return id;
    }
    
    public String getStandardId() {
        return standardId;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getDescription() {
        return description;
    }
    
    public void setDescription(String description) {
        this.description = description;
    }
    
    public String getValidationRule() {
        return validationRule;
    }
    
    public void setValidationRule(String validationRule) {
        this.validationRule = validationRule;
    }
}
```

**应用服务**：

```java
/**
 * 数据标准应用服务
 */
@Service
@Transactional
public class StandardApplicationService implements StandardService {
    private final DataStandardRepository standardRepository;
    private final DomainEventPublisher eventPublisher;
    
    @Override
    public DataStandardDTO createDataStandard(CreateDataStandardCommand command) {
        // 创建数据标准
        DataStandard standard = new DataStandard(
            DataStandardId.generate(),
            command.getName(),
            command.getType(),
            "1.0.0", // 初始版本
            command.getCreatedBy()
        );
        
        // 设置描述
        standard.setDescription(command.getDescription());
        
        // 设置域
        standard.setDomain(command.getDomain());
        
        // 添加定义
        if (command.getDefinitions() != null) {
            command.getDefinitions().forEach(def -> 
                standard.addDefinition(
                    def.getName(),
                    def.getDescription(),
                    def.getValidationRule(),
                    command.getCreatedBy()
                )
            );
        }
        
        // 保存标准
        standardRepository.save(standard);
        
        // 发布领域事件
        eventPublisher.publish(new DataStandardCreatedEvent(
            standard.getId().getValue(),
            standard.getName(),
            standard.getType().name()
        ));
        
        // 返回DTO
        return DataStandardDTOAssembler.toDTO(standard);
    }
    
    @Override
    public DataStandardDTO getDataStandard(String standardId) {
        DataStandard standard = findStandardById(standardId);
        return DataStandardDTOAssembler.toDTO(standard);
    }
    
    @Override
    public DataStandardDTO updateDataStandard(UpdateDataStandardCommand command) {
        // 获取标准
        DataStandard standard = findStandardById(command.getStandardId());
        
        // 验证状态
        if (standard.getStatus() != StandardStatus.DRAFT) {
            throw new IllegalStateException("Only draft standards can be updated");
        }
        
        // 更新基本信息
        standard.setDescription(command.getDescription());
        standard.setDomain(command.getDomain());
        
        // 更新定义
        if (command.getDefinitionsToAdd() != null) {
            command.getDefinitionsToAdd().forEach(def -> 
                standard.addDefinition(
                    def.getName(),
                    def.getDescription(),
                    def.getValidationRule(),
                    command.getUpdatedBy()
                )
            );
        }
        
        if (command.getDefinitionsToRemove() != null) {
            command.getDefinitionsToRemove().forEach(defId -> 
                standard.removeDefinition(
                    StandardDefinitionId.of(defId),
                    command.getUpdatedBy()
                )
            );
        }
        
        // 保存标准
        standardRepository.save(standard);
        
        // 发布领域事件
        eventPublisher.publish(new DataStandardUpdatedEvent(
            standard.getId().getValue(),
            standard.getName()
        ));
        
        // 返回DTO
        return DataStandardDTOAssembler.toDTO(standard);
    }
    
    @Override
    public void publishDataStandard(String standardId, String updatedBy) {
        // 获取标准
        DataStandard standard = findStandardById(standardId);
        
        // 发布标准
        standard.publish(updatedBy);
        
        // 保存标准
        standardRepository.save(standard);
        
        // 发布领域事件
        eventPublisher.publish(new DataStandardPublishedEvent(
            standard.getId().getValue(),
            standard.getName()
        ));
    }
    
    @Override
    public void deprecateDataStandard(String standardId, String updatedBy) {
        // 获取标准
        DataStandard standard = findStandardById(standardId);
        
        // 废弃标准
        standard.deprecate(updatedBy);
        
        // 保存标准
        standardRepository.save(standard);
        
        // 发布领域事件
        eventPublisher.publish(new DataStandardDeprecatedEvent(
            standard.getId().getValue(),
            standard.getName()
        ));
    }
    
    @Override
    public DataStandardDTO validateAgainstStandard(ValidateAgainstStandardCommand command) {
        // 获取标准
        DataStandard standard = findStandardById(command.getStandardId());
        
        // 验证状态
        if (standard.getStatus() != StandardStatus.PUBLISHED) {
            throw new IllegalStateException("Only published standards can be used for validation");
        }
        
        // 执行验证并返回结果
        // 此处简化处理，实际实现需要根据标准定义和验证规则进行复杂的验证逻辑
        // 可能需要使用规则引擎或其他验证机制
        
        // 返回标准DTO
        return DataStandardDTOAssembler.toDTO(standard);
    }
    
    private DataStandard findStandardById(String standardId) {
        return standardRepository.findById(DataStandardId.of(standardId))
            .orElseThrow(() -> new StandardNotFoundException("Standard not found: " + standardId));
    }
}
```

### platform-data-governance-cleansing

**职责**：
- 实现数据清洗功能
- 提供脏数据识别和处理机制
- 支持清洗规则定义和执行

**领域模型**：

```java
/**
 * 清洗任务域模型
 */
@Entity
@Table(name = "gov_cleansing_task")
public class CleansingTask implements AggregateRoot<CleansingTaskId> {
    @EmbeddedId
    private CleansingTaskId id;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "source_id", nullable = false)
    private String sourceId;
    
    @Column(name = "target_id")
    private String targetId;
    
    @Column(name = "task_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private CleansingType type;
    
    @Column(name = "status", nullable = false)
    @Enumerated(EnumType.STRING)
    private TaskStatus status;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @OneToMany(mappedBy = "taskId", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<CleansingRule> rules = new HashSet<>();
    
    @OneToMany(mappedBy = "taskId", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<CleansingExecution> executions = new ArrayList<>();
    
    protected CleansingTask() {}
    
    public CleansingTask(CleansingTaskId id, String name, String sourceId, 
                        CleansingType type, String createdBy) {
        this.id = id;
        this.name = name;
        this.sourceId = sourceId;
        this.type = type;
        this.status = TaskStatus.INACTIVE;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    public void addRule(String name, String description, String ruleDef, 
                       RulePriority priority, String createdBy) {
        CleansingRule rule = new CleansingRule(
            CleansingRuleId.generate(),
            this.id.getValue(),
            name,
            ruleDef,
            priority,
            createdBy
        );
        
        rule.setDescription(description);
        this.rules.add(rule);
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = createdBy;
    }
    
    public void removeRule(CleansingRuleId ruleId, String updatedBy) {
        this.rules.removeIf(r -> r.getId().equals(ruleId));
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = updatedBy;
    }
    
    public void activate() {
        if (this.status == TaskStatus.INACTIVE) {
            this.status = TaskStatus.ACTIVE;
            this.updatedAt = LocalDateTime.now();
        }
    }
    
    public void deactivate() {
        if (this.status == TaskStatus.ACTIVE) {
            this.status = TaskStatus.INACTIVE;
            this.updatedAt = LocalDateTime.now();
        }
    }
    
    public CleansingExecution startExecution(String executedBy) {
        if (this.status != TaskStatus.ACTIVE) {
            throw new TaskInactiveException("Cannot execute inactive task: " + this.id.getValue());
        }
        
        CleansingExecution execution = new CleansingExecution(
            CleansingExecutionId.generate(),
            this.id.getValue(),
            ExecutionStatus.PENDING,
            executedBy
        );
        
        this.executions.add(execution);
        this.updatedAt = LocalDateTime.now();
        
        return execution;
    }
    
    @Override
    public CleansingTaskId getId() {
        return id;
    }
    
    // Getter methods
}

/**
 * 清洗规则
 */
@Entity
@Table(name = "gov_cleansing_rule")
public class CleansingRule {
    @EmbeddedId
    private CleansingRuleId id;
    
    @Column(name = "task_id", nullable = false)
    private String taskId;
    
    @Column(name = "name", nullable = false)
    private String name;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "rule_definition", nullable = false, columnDefinition = "TEXT")
    private String ruleDefinition;
    
    @Column(name = "priority", nullable = false)
    @Enumerated(EnumType.STRING)
    private RulePriority priority;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", nullable = false)
    private String createdBy;
    
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    protected CleansingRule() {}
    
    public CleansingRule(CleansingRuleId id, String taskId, String name, 
                        String ruleDefinition, RulePriority priority, String createdBy) {
        this.id = id;
        this.taskId = taskId;
        this.name = name;
        this.ruleDefinition = ruleDefinition;
        this.priority = priority;
        this.createdAt = LocalDateTime.now();
        this.updatedAt = this.createdAt;
        this.createdBy = createdBy;
        this.updatedBy = createdBy;
    }
    
    // Getter and setter methods
    
    public CleansingRuleId getId() {
        return id;
    }
    
    public String getTaskId() {
        return taskId;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getDescription() {
        return description;
    }
    
    public void setDescription(String description) {
        this.description = description;
    }
    
    public String getRuleDefinition() {
        return ruleDefinition;
    }
    
    public void setRuleDefinition(String ruleDefinition) {
        this.ruleDefinition = ruleDefinition;
    }
    
    public RulePriority getPriority() {
        return priority;
    }
    
    public void setPriority(RulePriority priority) {
        this.priority = priority;
    }
}

/**
 * 清洗执行
 */
@Entity
@Table(name = "gov_cleansing_execution")
public class CleansingExecution {
    @EmbeddedId
    private CleansingExecutionId id;
    
    @Column(name = "task_id", nullable = false)
    private String taskId;
    
    @Column(name = "status", nullable = false)
    @Enumerated(EnumType.STRING)
    private ExecutionStatus status;
    
    @Column(name = "start_time", nullable = false)
    private LocalDateTime startTime;
    
    @Column(name = "end_time")
    private LocalDateTime endTime;
    
    @Column(name = "total_records")
    private Long totalRecords;
    
    @Column(name = "processed_records")
    private Long processedRecords;
    
    @Column(name = "cleansed_records")
    private Long cleansedRecords;
    
    @Column(name = "error_records")
    private Long errorRecords;
    
    @Column(name = "error_message")
    private String errorMessage;
    
    @Column(name = "executed_by", nullable = false)
    private String executedBy;
    
    protected CleansingExecution() {}
    
    public CleansingExecution(CleansingExecutionId id, String taskId, 
                             ExecutionStatus status, String executedBy) {
        this.id = id;
        this.taskId = taskId;
        this.status = status;
        this.startTime = LocalDateTime.now();
        this.executedBy = executedBy;
    }
    
    public void start() {
        this.status = ExecutionStatus.RUNNING;
    }
    
    public void complete(long totalRecords, long processedRecords, 
                        long cleansedRecords, long errorRecords) {
        this.status = ExecutionStatus.COMPLETED;
        this.endTime = LocalDateTime.now();
        this.totalRecords = totalRecords;
        this.processedRecords = processedRecords;
        this.cleansedRecords = cleansedRecords;
        this.errorRecords = errorRecords;
    }
    
    public void fail(String errorMessage) {
        this.status = ExecutionStatus.FAILED;
        this.endTime = LocalDateTime.now();
        this.errorMessage = errorMessage;
    }
    
    // Getter methods
    
    public CleansingExecutionId getId() {
        return id;
    }
    
    public String getTaskId() {
        return taskId;
    }
    
    public ExecutionStatus getStatus() {
        return status;
    }
    
    public LocalDateTime getStartTime() {
        return startTime;
    }
    
    public LocalDateTime getEndTime() {
        return endTime;
    }
    
    public Long getTotalRecords() {
        return totalRecords;
    }
    
    public Long getProcessedRecords() {
        return processedRecords;
    }
    
    public Long getCleansedRecords() {
        return cleansedRecords;
    }
    
    public Long getErrorRecords() {
        return errorRecords;
    }
    
    public String getErrorMessage() {
        return errorMessage;
    }
    
    public String getExecutedBy() {
        return executedBy;
    }
}
```

**应用服务**：

```java
/**
 * 数据清洗应用服务
 */
@Service
@Transactional
public class CleansingApplicationService implements CleansingService {
    private final CleansingTaskRepository taskRepository;
    private final CleansingExecutionRepository executionRepository;
    private final CleansingEngine cleansingEngine;
    private final DomainEventPublisher eventPublisher;
    
    @Override
    public CleansingTaskDTO createCleansingTask(CreateCleansingTaskCommand command) {
        // 创建清洗任务
        CleansingTask task = new CleansingTask(
            CleansingTaskId.generate(),
            command.getName(),
            command.getSourceId(),
            command.getType(),
            command.getCreatedBy()
        );
        
        // 设置描述
        task.setDescription(command.getDescription());
        
        // 设置目标数据源
        if (command.getTargetId() != null) {
            task.setTargetId(command.getTargetId());
        }
        
        // 添加规则
        if (command.getRules() != null) {
            command.getRules().forEach(rule -> 
                task.addRule(
                    rule.getName(),
                    rule.getDescription(),
                    rule.getRuleDefinition(),
                    rule.getPriority(),
                    command.getCreatedBy()
                )
            );
        }
        
        // 保存任务
        taskRepository.save(task);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingTaskCreatedEvent(
            task.getId().getValue(),
            task.getName(),
            task.getType().name()
        ));
        
        // 返回DTO
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingTaskDTO getCleansingTask(String taskId) {
        CleansingTask task = findTaskById(taskId);
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingTaskDTO addRule(AddCleansingRuleCommand command) {
        // 获取任务
        CleansingTask task = findTaskById(command.getTaskId());
        
        // 添加规则
        task.addRule(
            command.getName(),
            command.getDescription(),
            command.getRuleDefinition(),
            command.getPriority(),
            command.getCreatedBy()
        );
        
        // 保存任务
        taskRepository.save(task);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingRuleAddedEvent(
            task.getId().getValue(),
            command.getName()
        ));
        
        // 返回DTO
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingTaskDTO removeRule(RemoveCleansingRuleCommand command) {
        // 获取任务
        CleansingTask task = findTaskById(command.getTaskId());
        
        // 移除规则
        task.removeRule(
            CleansingRuleId.of(command.getRuleId()),
            command.getUpdatedBy()
        );
        
        // 保存任务
        taskRepository.save(task);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingRuleRemovedEvent(
            task.getId().getValue(),
            command.getRuleId()
        ));
        
        // 返回DTO
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingTaskDTO activateTask(String taskId, String updatedBy) {
        // 获取任务
        CleansingTask task = findTaskById(taskId);
        
        // 激活任务
        task.activate();
        task.setUpdatedBy(updatedBy);
        
        // 保存任务
        taskRepository.save(task);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingTaskActivatedEvent(
            task.getId().getValue(),
            task.getName()
        ));
        
        // 返回DTO
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingTaskDTO deactivateTask(String taskId, String updatedBy) {
        // 获取任务
        CleansingTask task = findTaskById(taskId);
        
        // 停用任务
        task.deactivate();
        task.setUpdatedBy(updatedBy);
        
        // 保存任务
        taskRepository.save(task);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingTaskDeactivatedEvent(
            task.getId().getValue(),
            task.getName()
        ));
        
        // 返回DTO
        return CleansingTaskDTOAssembler.toDTO(task);
    }
    
    @Override
    public CleansingExecutionDTO executeTask(ExecuteCleansingTaskCommand command) {
        // 获取任务
        CleansingTask task = findTaskById(command.getTaskId());
        
        // 创建执行记录
        CleansingExecution execution = task.startExecution(command.getExecutedBy());
        
        // 保存执行记录
        executionRepository.save(execution);
        
        // 发布领域事件
        eventPublisher.publish(new CleansingExecutionCreatedEvent(
            execution.getId().getValue(),
            task.getId().getValue()
        ));
        
        // 异步执行清洗任务
        taskExecutor.execute(() -> {
            try {
                // 更新执行状态
                execution.start();
                executionRepository.save(execution);
                
                // 执行清洗
                CleansingResult result = cleansingEngine.execute(task, execution.getId().getValue());
                
                // 更新执行结果
                execution.complete(
                    result.getTotalRecords(),
                    result.getProcessedRecords(),
                    result.getCleansedRecords(),
                    result.getErrorRecords()
                );
                executionRepository.save(execution);
                
                // 发布执行完成事件
                eventPublisher.publish(new CleansingExecutionCompletedEvent(
                    execution.getId().getValue(),
                    task.getId().getValue(),
                    result.getCleansedRecords()
                ));
                
            } catch (Exception e) {
                // 记录异常
                execution.fail(e.getMessage());
                executionRepository.save(execution);
                
                // 发布执行失败事件
                eventPublisher.publish(new CleansingExecutionFailedEvent(
                    execution.getId().getValue(),
                    task.getId().getValue(),
                    e.getMessage()
                ));
            }
        });
        
        // 返回执行DTO
        return CleansingExecutionDTOAssembler.toDTO(execution);
    }
    
    @Override
    public CleansingExecutionDTO getExecutionStatus(String executionId) {
        CleansingExecution execution = executionRepository.findById(CleansingExecutionId.of(executionId))
            .orElseThrow(() -> new ExecutionNotFoundException("Execution not found: " + executionId));
            
        return CleansingExecutionDTOAssembler.toDTO(execution);
    }
    
    private CleansingTask findTaskById(String taskId) {
        return taskRepository.findById(CleansingTaskId.of(taskId))
            .orElseThrow(() -> new CleansingTaskNotFoundException("Cleansing task not found: " + taskId));
    }
}
```

## 配置范例

```yaml
spring:
  application:
    name: platform-data-governance
  datasource:
    url: jdbc:mysql://${MYSQL_HOST:localhost}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:governance_db}?useSSL=false&serverTimezone=UTC
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
    open-in-view: false

# 数据治理配置
governance:
  metadata:
    cache-enabled: true
    cache-ttl-minutes: 30
  quality:
    execution:
      max-concurrent-tasks: 10
      timeout-minutes: 60
    rule-engine:
      default-engine: SCRIPT
  lineage:
    max-depth: 10
    cache-enabled: true
  standard:
    version-control:
      enabled: true
      max-versions: 5
  cleansing:
    max-concurrent-tasks: 5
    batch-size: 1000

server:
  port: 8083

management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: ALWAYS
```