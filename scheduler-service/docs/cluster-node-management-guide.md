# 集群节点管理功能指南

## 概述

集群节点管理是分布式任务调度系统的核心组件，负责协调多个调度节点的工作，确保任务能够可靠地在分布式环境中执行。本系统实现了完善的集群节点管理功能，包括节点注册与发现、心跳检测、状态监控、负载均衡、主节点选举等，为分布式任务调度提供了坚实的基础。

## 功能特性

1. **节点生命周期管理**
   - 节点自动注册与注销
   - 心跳机制监控节点健康状态
   - 自动处理超时节点和故障节点

2. **主节点选举**
   - 基于分布式锁的主节点选举机制
   - 主节点自动故障转移
   - 集群协调任务分配

3. **节点负载均衡**
   - 多种负载均衡策略支持
   - 任务动态分配到最合适的节点
   - 节点负载监控和调整

4. **节点状态管理**
   - 丰富的节点状态定义
   - 节点状态自动转换
   - 节点状态监控和报警

5. **任务故障转移**
   - 节点故障时自动重分配任务
   - 确保任务不会丢失
   - 支持任务重试和恢复

## 架构设计

集群节点管理功能的核心架构由以下几个部分组成：

1. **NodeStatus**
   - 定义节点的各种状态
   - 提供状态判断和转换方法
   - 状态包括：在线、离线、超时、故障、忙碌、空闲等

2. **LoadBalanceStrategy**
   - 负载均衡策略接口
   - 多种策略实现：轮询、哈希、最小负载
   - 可扩展的策略设计

3. **ClusterManager**
   - 集群管理核心组件
   - 负责集群的初始化和维护
   - 处理节点心跳、状态检查、主节点选举

4. **SchedulerNodeService**
   - 节点管理服务接口
   - 提供节点注册、心跳更新、状态查询等功能
   - 负责节点之间的任务分配

## 节点状态说明

节点在生命周期中会经历不同的状态：

| 状态 | 代码 | 描述 | 是否可分配任务 |
|------|------|------|----------------|
| 在线 | ONLINE | 节点正常运行 | 是 |
| 离线 | OFFLINE | 节点已下线 | 否 |
| 超时 | TIMEOUT | 节点心跳超时 | 否 |
| 故障 | FAULT | 节点发生故障 | 否 |
| 忙碌 | BUSY | 节点负载高 | 否 |
| 空闲 | IDLE | 节点负载低 | 是 |
| 维护 | MAINTENANCE | 节点处于维护状态 | 否 |
| 禁用 | DISABLED | 节点被手动禁用 | 否 |
| 启动中 | STARTING | 节点正在启动 | 否 |
| 关闭中 | STOPPING | 节点正在关闭 | 否 |

## 负载均衡策略

系统实现了多种负载均衡策略：

1. **轮询策略 (RoundRobin)**
   - 轮流将任务分配给各个节点
   - 适合节点性能相近的情况
   - 实现简单，分配均匀

2. **哈希策略 (Hash)**
   - 根据任务ID哈希值选择节点
   - 确保相同任务总是分配到相同节点
   - 有利于任务数据的本地缓存

3. **最小负载策略 (LeastLoad)**
   - 选择当前负载最小的节点
   - 动态监控节点负载情况
   - 实现更好的资源利用

## 配置说明

在application.yml中添加集群节点管理相关配置：

```yaml
scheduler:
  cluster:
    health-check-rate: 30000  # 节点健康检查频率，单位毫秒
    load-balance-strategy: RoundRobin  # 负载均衡策略
    node-timeout: 60  # 节点超时时间，单位秒
    leader-elect-enabled: true  # 是否启用主节点选举
```

## 主节点选举

主节点选举基于Redis分布式锁实现：

1. 所有节点定期尝试获取名为"cluster_leader_lock"的分布式锁
2. 成功获取锁的节点成为主节点
3. 锁设置一定的过期时间，确保主节点故障时能够自动重新选举
4. 主节点负责集群范围内的任务，如处理超时节点

## 使用指南

### 节点注册

节点在启动时自动注册到集群：

```java
@Autowired
private SchedulerNodeService nodeService;

// 获取当前节点
SchedulerNode currentNode = nodeService.getCurrentNode();
System.out.println("当前节点ID: " + currentNode.getNodeId());
```

### 节点心跳更新

节点需定期更新心跳，表明自己仍然存活：

```java
// 更新心跳
boolean success = nodeService.updateHeartbeat(nodeId);
```

### 节点状态查询

查询集群中的节点状态：

```java
// 查询所有在线节点
List<SchedulerNode> onlineNodes = nodeService.findOnlineNodes();

// 查询特定状态的节点
Page<SchedulerNode> busyNodes = nodeService.findNodesByStatus(
    NodeStatus.BUSY.getCode(), PageRequest.of(0, 10));
```

### 节点负载均衡

为任务选择合适的执行节点：

```java
// 为任务选择节点
SchedulerNode selectedNode = nodeService.selectNodeForTask(taskId);
```

### 判断主节点

判断当前节点是否是主节点：

```java
// 判断当前节点是否是主节点
boolean isLeader = nodeService.isCurrentNodeLeader();

// 只有主节点执行的操作
if (isLeader) {
    // 处理集群范围的任务
}
```

## 节点故障处理

当节点发生故障或心跳超时时，系统会自动进行处理：

1. 主节点定期检查所有节点的心跳时间
2. 对于超过阈值未更新心跳的节点，标记为超时状态
3. 自动重新分配超时节点上的运行中任务
4. 将这些任务标记为失败，等待重新调度或重试

```java
// 处理超时节点
int count = nodeService.handleTimeoutNodes(60); // 60秒超时
```

## 任务重新分配

当节点下线或故障时，需要重新分配该节点上的任务：

```java
// 重新分配节点上的任务
int reassignedCount = nodeService.reassignTasks(nodeId);
```

重分配过程包括：

1. 获取节点上所有运行中的任务
2. 将这些任务标记为失败状态
3. 更新任务执行记录
4. 任务将根据重试策略决定是否重新执行

## 集群扩展性

集群节点管理设计支持动态扩展：

1. **节点动态加入**
   - 新节点启动后自动注册到集群
   - 无需重启其他节点
   - 新节点立即参与任务调度

2. **节点平滑下线**
   - 节点可以优雅关闭
   - 自动转移节点上的任务
   - 不影响集群整体运行

3. **水平扩展**
   - 集群可以根据负载动态增加节点
   - 负载均衡策略自动适应节点变化
   - 支持大规模集群部署

## 监控与管理

系统提供了丰富的集群监控和管理功能：

1. **节点状态监控**
   - 实时查看所有节点状态
   - 节点健康状况统计
   - 节点负载监控

2. **负载均衡监控**
   - 任务分配情况统计
   - 各节点任务执行数量
   - 负载均衡效果分析

3. **节点管理操作**
   - 手动上线/下线节点
   - 调整节点负载设置
   - 节点维护模式切换

## 高可用设计

集群节点管理功能的高可用设计包括：

1. **无单点故障**
   - 主节点自动选举
   - 任何节点故障不影响整体服务
   - 任务自动重分配

2. **自动故障恢复**
   - 节点故障自动检测
   - 任务自动转移
   - 节点恢复后自动加入集群

3. **数据一致性保障**
   - 基于分布式锁的并发控制
   - 事务保证数据一致性
   - 任务状态可追踪和恢复

## 注意事项

1. **节点时钟同步**
   - 确保所有节点的时钟同步，避免心跳检测误判
   - 建议使用NTP服务

2. **网络稳定性**
   - 节点之间的网络通信对集群稳定性至关重要
   - 建议使用可靠的网络环境

3. **资源规划**
   - 根据任务特性合理规划节点资源
   - 考虑任务峰值情况下的资源需求

4. **安全性考虑**
   - 集群节点间通信安全
   - 节点身份认证
   - 访问控制和权限管理

## 最佳实践

1. **合理分配资源**
   - 根据任务类型和负载分配不同规格的节点
   - 性能密集型任务和IO密集型任务分开调度

2. **选择合适的负载均衡策略**
   - 任务无状态且均匀：轮询策略
   - 任务有本地数据依赖：哈希策略
   - 节点性能差异大：最小负载策略

3. **定期维护**
   - 定期检查集群健康状况
   - 分析节点负载分布情况
   - 根据业务增长适时扩展节点

4. **日志与监控**
   - 建立完善的日志收集系统
   - 设置关键指标告警
   - 定期分析集群性能数据

## 故障排除

1. **节点无法注册**
   - 检查网络连接
   - 确认数据库连接正常
   - 验证节点配置正确

2. **节点频繁超时**
   - 检查节点负载是否过高
   - 验证网络延迟情况
   - 调整超时阈值参数

3. **主节点选举失败**
   - 检查Redis连接状况
   - 确认分布式锁机制正常
   - 查看节点日志分析原因

4. **任务分配不均衡**
   - 检查负载均衡策略配置
   - 分析节点资源使用情况
   - 调整节点权重或容量设置
