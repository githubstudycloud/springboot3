# 服务架构与调用链分析

## 1. 微服务架构概述

本项目采用微服务架构，将系统拆分成多个独立部署、独立运行的服务。主要服务包括：

- 服务注册与发现（platform-registry）
- 配置中心（platform-config）
- API网关（platform-gateway）
- 认证授权服务（platform-auth-service）
- 监控仪表板（platform-monitor-dashboard）
- 调度系统（platform-scheduler）
- 数据可视化（platform-data-visualization）

各服务之间的关系如下图所示：

```mermaid
graph TB
    Client[客户端] --> Gateway[API网关]
    Gateway --> Auth[认证授权服务]
    Gateway --> Scheduler[调度系统]
    Gateway --> Monitor[监控仪表板]
    Gateway --> DataViz[数据可视化]
    
    subgraph 基础设施服务
        Registry[服务注册中心]
        Config[配置中心]
    end
    
    Auth --> Registry
    Scheduler --> Registry
    Monitor --> Registry
    DataViz --> Registry
    Gateway --> Registry
    
    Auth --> Config
    Scheduler --> Config
    Monitor --> Config
    DataViz --> Config
    Gateway --> Config
```

## 2. 服务注册与发现

服务注册与发现基于Nacos实现，主要工作流程如下：

```mermaid
sequenceDiagram
    participant 微服务
    participant Nacos注册中心
    participant 服务消费者
    
    微服务->>Nacos注册中心: 1. 服务注册(应用名,IP,端口)
    微服务->>Nacos注册中心: 2. 发送心跳包
    Nacos注册中心-->>微服务: 3. 配置变更通知
    服务消费者->>Nacos注册中心: 4. 订阅服务
    Nacos注册中心-->>服务消费者: 5. 返回服务列表
    Nacos注册中心-->>服务消费者: 6. 服务变更通知
    服务消费者->>微服务: 7. 服务调用
```

### 2.1 关键配置

服务注册配置示例：

```yaml
spring:
  application:
    name: platform-auth-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: ${spring.profiles.active:dev}
```

## 3. API网关

API网关使用Spring Cloud Gateway实现，主要职责包括：

- 路由转发
- 统一认证
- 限流控制
- 请求日志
- 响应缓存

### 3.1 网关调用流程

```mermaid
sequenceDiagram
    participant 客户端
    participant 网关
    participant 认证服务
    participant 目标服务
    
    客户端->>网关: 1. 发送API请求
    网关->>网关: 2. 路由匹配
    网关->>网关: 3. 前置过滤器链处理
    网关->>认证服务: 4. 校验token(可选)
    认证服务-->>网关: 5. 返回认证结果
    网关->>目标服务: 6. 转发请求
    目标服务-->>网关: 7. 返回响应
    网关->>网关: 8. 后置过滤器链处理
    网关-->>客户端: 9. 返回处理结果
```

### 3.2 网关路由配置

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: auth-service
          uri: lb://platform-auth-service
          predicates:
            - Path=/auth/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
```

## 4. 认证授权服务

认证授权服务基于Spring Security和JWT实现，提供用户认证、权限管理和令牌颁发功能。

### 4.1 认证流程

```mermaid
sequenceDiagram
    participant 客户端
    participant 网关
    participant 认证服务
    participant 数据库
    
    客户端->>网关: 1. 登录请求(用户名/密码)
    网关->>认证服务: 2. 转发登录请求
    认证服务->>数据库: 3. 查询用户信息
    数据库-->>认证服务: 4. 返回用户数据
    认证服务->>认证服务: 5. 校验密码
    认证服务->>认证服务: 6. 生成JWT令牌
    认证服务-->>网关: 7. 返回JWT令牌
    网关-->>客户端: 8. 返回JWT令牌
    
    客户端->>网关: 9. 请求资源(携带JWT)
    网关->>认证服务: 10. 验证JWT
    认证服务-->>网关: 11. JWT有效
    网关->>目标服务: 12. 转发请求(带权限信息)
```

### 4.2 权限模型

系统采用RBAC(基于角色的访问控制)权限模型，主要包括：

```mermaid
classDiagram
    User "1" -- "*" Role : has
    Role "1" -- "*" Permission : contains
    Permission "1" -- "*" Resource : controls
    
    class User {
        +Long id
        +String username
        +String password
        +String email
        +Boolean enabled
    }
    
    class Role {
        +Long id
        +String name
        +String description
    }
    
    class Permission {
        +Long id
        +String code
        +String description
    }
    
    class Resource {
        +Long id
        +String type
        +String path
        +String method
    }
```

## 5. 配置中心

配置中心基于Nacos实现，提供集中配置管理、动态配置刷新等功能。

### 5.1 配置获取流程

```mermaid
sequenceDiagram
    participant 微服务
    participant SpringCloudConfig
    participant Nacos配置中心
    
    微服务->>SpringCloudConfig: 1. 启动时请求配置
    SpringCloudConfig->>Nacos配置中心: 2. 获取配置
    Nacos配置中心-->>SpringCloudConfig: 3. 返回配置信息
    SpringCloudConfig-->>微服务: 4. 配置注入
    
    Nacos配置中心->>SpringCloudConfig: 5. 配置变更通知
    SpringCloudConfig->>微服务: 6. 刷新配置(RefreshScope)
```

### 5.2 配置项结构

```mermaid
graph TB
    A[配置中心] --> B[环境维度]
    B --> B1[dev]
    B --> B2[test]
    B --> B3[prod]
    
    A --> C[应用维度]
    C --> C1[platform-auth-service.yaml]
    C --> C2[platform-gateway.yaml]
    C --> C3[platform-scheduler.yaml]
    
    A --> D[全局配置]
    D --> D1[application.yaml]
    D --> D2[datasource.yaml]
    D --> D3[redis.yaml]
```

## 6. 监控仪表板

监控仪表板服务提供系统健康状态、性能指标的可视化展示。

### 6.1 监控数据流

```mermaid
graph LR
    A[各微服务] -->|收集指标| B[Actuator]
    B -->|暴露端点| C[监控仪表板]
    C -->|存储| D[(时序数据库)]
    C -->|展示| E[Web UI]
    C -->|告警| F[告警模块]
    F -->|通知| G[通知服务]
```

### 6.2 主要监控指标

- 服务健康状态
- JVM内存使用
- GC情况
- 线程使用
- HTTP请求统计
- 数据库连接池状态
- 自定义业务指标

## 7. 调度系统

调度系统负责任务的定时执行、依赖管理和分布式协调。

### 7.1 调度系统架构

```mermaid
graph TB
    subgraph 调度中心
        A[调度器]
        B[任务管理]
        C[依赖解析]
    end
    
    subgraph 执行节点集群
        D[执行器1]
        E[执行器2]
        F[执行器3]
    end
    
    A --> D
    A --> E
    A --> F
    
    G[(元数据存储)] --> A
    G --> B
    G --> C
    
    H[任务日志] --> D
    H --> E
    H --> F
```

### 7.2 任务执行流程

```mermaid
sequenceDiagram
    participant 调度中心
    participant 执行器
    participant 任务处理器
    
    调度中心->>调度中心: 1. 扫描待执行任务
    调度中心->>调度中心: 2. 解析任务依赖
    调度中心->>执行器: 3. 派发任务
    执行器->>执行器: 4. 任务预处理
    执行器->>任务处理器: 5. 执行任务逻辑
    任务处理器-->>执行器: 6. 返回执行结果
    执行器-->>调度中心: 7. 上报执行状态
    调度中心->>调度中心: 8. 更新任务状态
    调度中心->>调度中心: 9. 处理后续任务
```

## 8. 服务间调用链分析

### 8.1 典型用户请求调用链

以用户登录并访问调度系统为例：

```mermaid
sequenceDiagram
    participant 用户
    participant 网关
    participant 认证服务
    participant 调度系统
    participant 配置中心
    participant 服务注册中心
    
    用户->>网关: 1. 登录请求
    网关->>认证服务: 2. 转发登录请求
    认证服务->>认证服务: 3. 验证凭证
    认证服务->>认证服务: 4. 生成令牌
    认证服务-->>网关: 5. 返回令牌
    网关-->>用户: 6. 返回令牌
    
    用户->>网关: 7. 请求调度系统(带令牌)
    网关->>认证服务: 8. 验证令牌
    认证服务-->>网关: 9. 令牌有效
    网关->>调度系统: 10. 转发请求
    
    调度系统->>服务注册中心: 11. 服务发现(可选)
    服务注册中心-->>调度系统: 12. 返回服务信息
    调度系统->>配置中心: 13. 获取配置(可选)
    配置中心-->>调度系统: 14. 返回配置
    
    调度系统->>调度系统: 15. 处理业务逻辑
    调度系统-->>网关: 16. 返回处理结果
    网关-->>用户: 17. 返回处理结果
```

### 8.2 系统间主要依赖关系

```mermaid
graph TD
    A[API网关] --> B[认证授权服务]
    A --> C[业务服务]
    
    B --> D[服务注册中心]
    B --> E[配置中心]
    
    C --> D
    C --> E
    C --> B
    
    F[监控仪表板] --> B
    F --> C
    F --> D
    F --> E
```

## 9. 重构建议

基于调用链分析，提出以下重构建议：

1. **提高服务弹性**：
   - 实现熔断机制(Circuit Breaker)
   - 添加重试机制和超时控制
   - 设置服务降级策略

2. **优化认证流程**：
   - 考虑分布式SSO
   - 引入OAuth2.0/OIDC规范
   - 实现令牌缓存和刷新机制

3. **完善服务治理**：
   - 添加分布式追踪(Distributed Tracing)
   - 实现全链路监控
   - 集成日志聚合系统

4. **API网关增强**：
   - 实现动态路由更新
   - 增加请求/响应数据转换
   - 加强安全防护措施

5. **微服务通信优化**：
   - 评估RPC与REST的适用场景
   - 考虑引入事件驱动架构
   - 优化序列化/反序列化性能 